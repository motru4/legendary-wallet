
---

# Legendary Wallet (API + Operation Worker)

–í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ—à–µ–ª—å–∫–æ–≤: REST-API –¥–ª—è –ø—Ä–∏—ë–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –≤–æ—Ä–∫–µ—Ä –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Kafka —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∑–∞–ø–∏—Å—å—é –≤ PostgreSQL –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Redis. –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø–æ–¥ 1000 RPS –Ω–∞ –æ–¥–∏–Ω –∫–æ—à–µ–ª—ë–∫, —Å—Ç—Ä–æ–≥–æ–º—É –ø–æ—Ä—è–¥–∫—É –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

## üîß –°—Ç–µ–∫

* **Golang**
* **PostgreSQL** 
* **Kafka** 
* **Redis** 
* **Docker / docker-compose**
* **Swagger/OpenAPI** 

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
‚îÇ  .env                 
‚îÇ  docker-compose.yml   
‚îÇ  LICENSE
‚îÇ
‚îú‚îÄ migrations/          
‚îÇ    001_init.sql
‚îÇ
‚îú‚îÄ operation-worker/
‚îÇ   ‚îú‚îÄ cmd/
‚îÇ   ‚îî‚îÄ internal/
‚îÇ       ‚îú‚îÄ app/ broker/ cache/ config/ database/ models/
‚îÇ       ‚îú‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îú‚îÄ postgresrepo/
‚îÇ       ‚îÇ   ‚îî‚îÄ redisrepo/
‚îÇ       ‚îú‚îÄ services/
‚îÇ       ‚îî‚îÄ worker/
‚îÇ
‚îî‚îÄ wallet-service/
    ‚îú‚îÄ cmd/
    ‚îú‚îÄ docs/            # Swagger
    ‚îî‚îÄ internal/
        ‚îú‚îÄ app/ broker/ cache/ config/ database/ models/
        ‚îú‚îÄ repositories/
        ‚îÇ   ‚îú‚îÄ kafkarepo/
        ‚îÇ   ‚îú‚îÄ postgresrepo/
        ‚îÇ   ‚îî‚îÄ redisrepo/
        ‚îú‚îÄ services/
        ‚îî‚îÄ transport/http
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–∞ `config.env`

### 2) –ü–æ–¥–Ω—è—Ç—å —Å–∏—Å—Ç–µ–º—É

```bash
docker compose up --build
```

---

## üåê API

### –†–æ—É—Ç—ã

```go
POST /api/v1/wallets                          // —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫
GET  /api/v1/wallets/{walletId}               // –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
POST /api/v1/wallet                           // —Å–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é (DEPOSIT/WITHDRAW)
GET  /api/v1/wallets/{walletId}/operations/{operationId} // —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏

GET  /swagger/ ...                            // Swagger UI
```

## üßµ –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Kafka) –∏ –∫–æ–Ω–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å

* –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É **–ø–∞—Ä—Ç–∏—Ü–∏–π** —Å–æ–∑–¥–∞—é—Ç—Å—è —á–∏—Ç–∞—Ç–µ–ª–µ–π Kafka - –∫–∞–∂–¥—ã–π –≤ —Å–≤–æ–µ–π –≥–æ—Ä—É—Ç–∏–Ω–µ.
* –ö–∞–∂–¥—ã–µ **100ms** –±–∞—Ç—á–µ—Ä –∑–∞–±–∏—Ä–∞–µ—Ç –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏ **–≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ `walletId`**.
* –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π:

  1. –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `SELECT ... FOR UPDATE` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –∫–æ—à–µ–ª—å–∫–∞.
  2. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –ë–î –∏ **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ** (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, —Å–ª—É—á–∞–π —Ä–µ—Å—Ç–∞—Ä—Ç–∞).
  3. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ **–≤ –ø–æ—Ä—è–¥–∫–µ Kafka**:

     * `DEPOSIT` ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å
     * `WITHDRAW` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤; –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ ‚Äî `FAILED` —Å –ø—Ä–∏—á–∏–Ω–æ–π
  4. –ú–∞—Å—Å–æ–≤–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –æ–ø–µ—Ä–∞—Ü–∏–π, –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å, –∫–æ–º–º–∏—Ç–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.
  5. –û–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –≤ Redis –∏ **–∫–æ–º–º–∏—Ç–∏—Ç –æ—Ñ—Ñ—Å–µ—Ç** –≤ Kafka.
* –î–æ—Å—Ç–∞–≤–∫–∞ –∏–∑ Kafka ‚Äî **at-least-once**. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–∞—é—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ ¬´–∫–∞–∫ exactly-once¬ª –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–æ–º–µ–Ω–∞.

---

## üß≠ –î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Mermaid)

```mermaid
flowchart LR

  subgraph API["wallet-service"]
    A["REST API"]
  end

  subgraph KAFKA["Kafka"]
    K["Topic: wallet-operations<br/>key = walletId"]
  end

  subgraph WORKER["operation-worker"]
    W1["Consumers per partition"]
    W2["Batcher (every 5s)"]
    W3["Service layer ¬∑ idempotent ¬∑ ordered"]
    W1 --> W2
    W2["Batcher (every n ms)"] --> W3
  end

  subgraph STORAGE["Storage"]
    R["Redis cache"]
    P["PostgreSQL"]
  end

  %% --- Client calls ---
  U
  A
  U -->|"GET/POST"| A
  U["Users"]
  A

  %% --- Write path ---
  A --> K
  K --> W1

  W3
  P
  W3
  P
  W3 --> P
  W3["Service layer"] --> R

  %% --- Read path ---
  A --> R
  R --> P

  %% ----- Styles -----
  classDef cache fill:#8b5cf6,stroke:#4c1d95,color:#fff;
  classDef db fill:#e0f2fe,stroke:#0284c7,color:#0f172a;
  class R cache;
  class P db;
```

---







